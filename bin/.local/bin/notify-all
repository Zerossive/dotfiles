#!/usr/bin/env bash
# ==============================================================================
# Script Name: notify-all
# Description: sends a notification to all listed devices
# Usage: notify-all [options] <message>
# Author: Danny Harris
# Dependencies: notify-send, paplay
# ==============================================================================

# -e: exit on error, -u: treat unset variables as errors, -o pipefail: pipe will fail if any command fails
set -euo pipefail

# global variables
message="$*"
summary=''
urgency=1
title='notify-all'
# TODO: experiment with action buttons

usage() {
    local cmd="${0##*/}"
    cat <<-EOF
		Notify all connected devices

		Usage: $cmd [options] <message>

		Options:
		  -t TITLE          title of notification
		  -s SUMMARY        summary of message
		  -u [0-3]          change urgency of notification 
		  -h                show this help message

		Useful Icons:
		   â³ðŸ¬ðŸ“¦ðŸ›ðŸ””ðŸ“œðŸ§¿ðŸ˜ˆðŸ¬ðŸ”·ðŸ’€ðŸ«†ðŸª³ðŸ–ðŸ§ŠðŸŒðŸ§­ðŸ›‘âš“ðŸŒœðŸ•¹ðŸŽ²ðŸƒðŸ’»ðŸ’¾ðŸ“šðŸ’¼ðŸ“…ðŸ“‹ðŸ”’ðŸ› ðŸ›¡âš âš¡

		Examples:
		  $cmd -t 'Urgent Message:' -u 2 there was an error
		  $cmd -t 'REMINDER' -i package -s 'this is a summary' do this thing
	EOF
}

error() {
    printf 'error: %s\n' "$*" >&2
    exit 1
}

# handle arguments
while getopts s:u:t:h flag; do
    case "${flag}" in
    u) urgency="$OPTARG" ;;
    t) title="$OPTARG" ;;
    s) summary="$OPTARG" ;;
    h)
        usage
        exit 0
        ;;
    ?)
        exit 2
        ;;
    esac
done
shift $((OPTIND - 1))
message="$*"
if [[ -z "$message" ]]; then
    error "no message provided"
fi

case "$urgency" in
0) urgency_notify_send="low" urgency_ntfy="low" ;;
1) urgency_notify_send="normal" urgency_ntfy="default" ;;
2) urgency_notify_send="critical" urgency_ntfy="high" ;;
3) urgency_notify_send="critical" urgency_ntfy="max" ;;
*) error "invalid argument for -i: $urgency" ;;
esac

# notify all devices
notify-devices() {
    printf 'notifying devices\n'
    local summary_modified=''
    [[ -n "$summary" ]] && summary_modified="[$summary]"
    curl -sd "$summary_modified$message" -H "Title: $title" -H "Priority: $urgency_ntfy" -H "Markdown: yes" olympus:8234/alerts >/dev/null || error "failed to notify devices"
}

# play desktop notification sound
play-desktop-sound() {
    # check for paplay
    if command -v paplay &>/dev/null; then
        # check for oga file
        local audio_file="/usr/share/sounds/freedesktop/stereo/complete.oga"
        if [ -f "$audio_file" ]; then
            paplay "$audio_file"
        else
            error "no oga file found for paplay"
        fi
    else
        error "paplay is not installed"
    fi
}

# notify desktop
notify-desktop() {
    printf 'notifying desktop\n'
    notify-send --app-name="$title" --icon="clock" -t 5000 --urgency="$urgency_notify_send" "$summary" "$message"
}

# check if notify-send is installed and notify desktop
if command -v notify-send &>/dev/null; then
    notify-desktop
    ((urgency > 0)) && play-desktop-sound
    ((urgency >= 3)) && play-desktop-sound
else
    error "notify-send is not installed"
fi

# notify all devices
notify-devices

# vim: set ft=sh:
